name: 'Build AnimekoEnhanced'

on:
  push:
    branches:
      - main
      - develop
    paths-ignore:
      - '**/*.md'
      - '.idea/**'
      - '.readme/**'
      - 'scripts/*'
  pull_request:
    paths-ignore:
      - '**/*.md'
      - '.idea/**'
      - '.readme/**'
      - 'scripts/*'
  workflow_dispatch:

concurrency:
  group: '${{ github.workflow }}-${{ github.event_name }}-${{ github.ref_name == ''main'' && github.run_id || github.ref_name }}'
  cancel-in-progress: true

jobs:
  build-windows:
    name: 'Build Windows x64'
    runs-on: windows-2022
    permissions:
      actions: 'write'
    steps:
      - name: 'Checkout'
        uses: 'actions/checkout@v4'
        with:
          submodules: 'recursive'

      - name: 'Setup local.properties'
        continue-on-error: true
        run: |
          rm -f local.properties
          echo "kotlin.native.ignoreDisabledTargets=true" >> local.properties

      - name: 'Setup JBR 21 for Windows'
        uses: 'actions/setup-java@v4'
        with:
          java-version: '21'
          distribution: 'zulu'

      - name: 'Setup Gradle'
        uses: 'gradle/actions/setup-gradle@v3'
        with:
          cache-disabled: 'false'

      - name: 'Build Desktop Application'
        run: './gradlew createReleaseDistributable --scan --stacktrace'
        timeout-minutes: 60

      - name: 'Upload Windows Portable'
        uses: 'actions/upload-artifact@v4'
        with:
          name: 'animekoenhanced-windows-x64'
          path: 'app/desktop/build/compose/binaries/main-release/app'
          if-no-files-found: 'error'
          retention-days: 30

  build-linux:
    name: 'Build Linux x64'
    runs-on: ubuntu-24.04
    permissions:
      actions: 'write'
    steps:
      - name: 'Checkout'
        uses: 'actions/checkout@v4'
        with:
          submodules: 'recursive'

      - name: 'Free Disk Space'
        uses: 'jlumbroso/free-disk-space@v1.3.1'
        with:
          android: 'false'
          large-packages: 'false'
          tool-cache: 'false'

      - name: 'Setup local.properties'
        continue-on-error: true
        run: |
          rm -f local.properties
          echo "kotlin.native.ignoreDisabledTargets=true" >> local.properties

      - name: 'Setup JBR 21 for Linux'
        uses: 'actions/setup-java@v4'
        with:
          java-version: '21'
          distribution: 'zulu'

      - name: 'Setup Gradle'
        uses: 'gradle/actions/setup-gradle@v3'
        with:
          cache-disabled: 'false'

      - name: 'Build Android APKs'
        run: './gradlew assembleDebug --scan --stacktrace'
        timeout-minutes: 60

      - name: 'Upload Android APK arm64-v8a'
        uses: 'actions/upload-artifact@v4'
        with:
          name: 'animekoenhanced-android-arm64-v8a'
          path: 'app/android/build/outputs/apk/debug/android-arm64-v8a-debug.apk'
          retention-days: 30

      - name: 'Upload Android APK universal'
        uses: 'actions/upload-artifact@v4'
        with:
          name: 'animekoenhanced-android-universal'
          path: 'app/android/build/outputs/apk/debug/android-universal-debug.apk'
          retention-days: 30

      - name: 'Build Desktop Application'
        run: './gradlew createReleaseDistributable --scan --stacktrace'
        timeout-minutes: 60

      - name: 'Build AppImage'
        run: |
          # Download appimagetool
          wget https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

          # Prepare AppDir
          mkdir -p AppDir/usr
          cp -r app/desktop/build/compose/binaries/main-release/app/Ani/* AppDir/usr

          cp app/desktop/appResources/linux-x64/AppRun AppDir/AppRun
          cp app/desktop/appResources/linux-x64/animeko.desktop AppDir/animeko.desktop
          cp app/desktop/appResources/linux-x64/icon.png AppDir/icon.png

          # Fix permissions
          chmod a+x AppDir/AppRun
          chmod a+x AppDir/usr/bin/Ani
          chmod a+x AppDir/usr/lib/runtime/lib/jcef_helper || true

          # Build AppImage
          ARCH=x86_64 ./appimagetool-x86_64.AppImage AppDir

      - name: 'Upload Linux AppImage'
        uses: 'actions/upload-artifact@v4'
        with:
          name: 'animekoenhanced-linux-x64-appimage'
          path: 'Animeko-x86_64.AppImage'
          if-no-files-found: 'error'
          retention-days: 30

  build-macos:
    name: 'Build macOS'
    runs-on: macos-14
    permissions:
      actions: 'write'
    steps:
      - name: 'Checkout'
        uses: 'actions/checkout@v4'
        with:
          submodules: 'recursive'

      - name: 'Setup local.properties'
        continue-on-error: true
        run: |
          rm -f local.properties
          echo "kotlin.native.ignoreDisabledTargets=true" >> local.properties

      - name: 'Setup JBR 21 for macOS'
        uses: 'actions/setup-java@v4'
        with:
          java-version: '21'
          distribution: 'zulu'

      - name: 'Setup Gradle'
        uses: 'gradle/actions/setup-gradle@v3'
        with:
          cache-disabled: 'false'

      - name: 'Build Desktop Application'
        run: './gradlew createReleaseDistributable --scan --stacktrace -Pani.android.abis=arm64-v8a'
        timeout-minutes: 60

      - name: 'Upload macOS App'
        uses: 'actions/upload-artifact@v4'
        with:
          name: 'animekoenhanced-macos-aarch64'
          path: 'app/desktop/build/compose/binaries/main-release/app/Ani.app'
          if-no-files-found: 'error'
          retention-days: 30
